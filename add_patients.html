{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-lg-6 col-md-8 col-sm-10">
        <div class="card shadow-sm p-4">
            <h2 class="text-center text-primary mb-4">➕ Add Patient</h2>
            <form id="addForm">

                <div class="mb-3">
                    <label for="patientId" class="form-label">Patient ID</label>
                    <input id="patientId" class="form-control" name="Patient ID" required>
                </div>

                <div class="mb-3">
                    <label for="name" class="form-label">Name</label>
                    <input id="name" class="form-control" name="Name" required>
                </div>

                <div class="mb-3">
                    <label for="number" class="form-label">Number</label>
                    <input id="number" class="form-control" name="Number" required>
                </div>

                <div class="mb-3">
                    <label for="age" class="form-label">Age</label>
                    <input id="age" class="form-control" name="Age" type="number">
                </div>

                <div class="mb-3">
                    <label for="gender" class="form-label">Gender</label>
                    <select id="gender" class="form-select" name="Gender">
                        <option value="" selected disabled>Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="occupation" class="form-label">Occupation</label>
                    <input id="occupation" class="form-control" name="Occupation">
                </div>

                <div class="mb-3">
                    <label for="refby" class="form-label">Ref. by</label>
                    <input id="refby" class="form-control" name="Ref. by">
                </div>

                <div class="mb-3">
                    <label for="address" class="form-label">Address</label>
                    <input id="address" class="form-control" name="Address">
                </div>

                <div class="mb-3">
                    <label for="doj" class="form-label">Date of joining</label>
                    <input id="doj" class="form-control" name="Date of joining" type="date">
                </div>

                <div class="mb-3">
                    <label for="conditions" class="form-label">Conditions</label>
                    <select id="conditions" class="form-select" name="Conditions">
                        <option value="" selected disabled>Select Condition</option>
                        <option value="Physiotherapy">Physiotherapy</option>
                        <option value="Pain Management">Pain Management</option>
                        <option value="Rehabilitation">Rehabilitation</option>
                        <option value="Post Surgery">Post Surgery</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="time" class="form-label">Time</label>
                    <input id="time" class="form-control" name="Time" type="time">
                </div>

                <div class="mb-3">
                    <label class="form-label">Visit Days</label>
                    <div id="visitDaysCheckboxes" class="d-flex flex-wrap gap-2">
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Monday" id="dayMonday"><label class="form-check-label" for="dayMonday">Monday</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Tuesday" id="dayTuesday"><label class="form-check-label" for="dayTuesday">Tuesday</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Wednesday" id="dayWednesday"><label class="form-check-label" for="dayWednesday">Wednesday</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Thursday" id="dayThursday"><label class="form-check-label" for="dayThursday">Thursday</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Friday" id="dayFriday"><label class="form-check-label" for="dayFriday">Friday</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Saturday" id="daySaturday"><label class="form-check-label" for="daySaturday">Saturday</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Sunday" id="daySunday"><label class="form-check-label" for="daySunday">Sunday</label></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox" value="Daily" id="dayDaily"><label class="form-check-label" for="dayDaily">Daily</label></div>
                    </div>
                    <input type="text" id="selectedDays" class="form-control mt-2" placeholder="Selected Days" readonly>
                </div>

                <button type="submit" class="btn btn-success w-100">Add Patient</button>
            </form>
        </div>
    </div>
</div>

<script>
// IMPORTANT: This list must EXACTLY match the CANONICAL_HEADERS list in your app.py
const CANONICAL_HEADERS = [
    "Patient ID",
    "Name",
    "Number",
    "Age",
    "Gender",
    "Occupation",
    "Ref. by",
    "Address",
    "Date of joining",
    "Conditions",
    "Time",
    "Visit Days",
    "Visit Count",
];

// Update selected days preview logic...
const checkboxes = document.querySelectorAll('#visitDaysCheckboxes input[type=checkbox]');
const selectedField = document.getElementById('selectedDays');
checkboxes.forEach(cb => {
    cb.addEventListener('change', () => {
        const selected = Array.from(checkboxes)
            .filter(i => i.checked)
            .map(i => i.value);
        selectedField.value = selected.join(', ');
    });
});

// Submit new patient logic
document.getElementById('addForm').addEventListener('submit', async e => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const formValues = {};
    
    // 1. Collect all raw form data into an object
    for (let pair of formData.entries()) {
        formValues[pair[0]] = pair[1];
    }
    
    // 2. Build the final payload using the canonical order, pulling values from formValues
    const finalPayload = {};
    
    // Iterate over the Canonical Order to ensure all keys are present and correctly ordered
    CANONICAL_HEADERS.forEach(header => {
        if (header === "Visit Count") {
            // Explicitly set initial Visit Count to "0"
            finalPayload[header] = "0";
        } else if (header === "Visit Days") {
            // Process Visit Days separately
            const selectedDays = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            finalPayload[header] = selectedDays;
        } else {
            // Pull value from form data, defaulting to empty string if no input was found
            finalPayload[header] = formValues[header] || "";
        }
    });

    if (finalPayload['Visit Days'].length === 0) {
        alert('Please select at least one Visit Day');
        return;
    }

    try {
        const res = await fetch('/api/patients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(finalPayload) // Send the strictly ordered payload
        });
        const result = await res.json();
        if (result.status === 'success') {
            alert('✅ Patient added successfully! Data is aligned.');
            e.target.reset();
            selectedField.value = '';
            window.location.href = '/history'; 
        } else {
            alert('⚠️ Error: ' + (result.message || 'Failed to add patient'));
        }
    } catch (err) {
        console.error('Error adding patient:', err);
        alert('⚠️ Error adding patient.');
    }
});
</script>

<style>
.card {
    border-radius: 15px;
    transition: transform 0.2s, box-shadow 0.2s;
}
.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
}
.form-control:focus {
    box-shadow: 0 0 5px rgba(0,123,255,0.5);
    border-color: #007bff;
}
#visitDaysCheckboxes .form-check {
    min-width: 120px;
}
</style>
{% endblock %}
