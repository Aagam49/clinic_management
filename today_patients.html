{% extends "base.html" %}
{% block content %}
<h2>
  Today's Patients (<span id="today-count" class="text-primary fw-bold">0</span>)
</h2>

<table class="table table-striped">
  <thead>
    <tr>
      <th>Patient ID</th>
      <th>Name</th>
      <th>Visit Days</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="todayBody"></tbody>
</table>

<script>
let pendingPatients = new Set();
let attendedPatients = new Set();

// ✅ Load attended list from localStorage
function loadAttendedFromStorage() {
  const saved = localStorage.getItem("attendedToday");
  if (saved) attendedPatients = new Set(JSON.parse(saved));
}

// ✅ Save attended list to localStorage
function saveAttendedToStorage() {
  localStorage.setItem("attendedToday", JSON.stringify([...attendedPatients]));
}

// ✅ Clear attended list automatically every new day
function resetIfNewDay() {
  const today = new Date().toDateString();
  const lastDay = localStorage.getItem("lastAttendanceDay");
  if (lastDay !== today) {
    localStorage.removeItem("attendedToday");
    localStorage.setItem("lastAttendanceDay", today);
  }
}

// ---- Load today's patients from backend ----
async function loadToday() {
  try {
    resetIfNewDay();
    loadAttendedFromStorage();
    const res = await fetch('/api/patients/today', { cache: "no-store" });
    const data = await res.json();
    renderTable(data);
    updateCount(data.length);
  } catch (err) {
    console.error("Error loading today's patients:", err);
    updateCount(0);
  }
}

function updateCount(count) {
  document.getElementById('today-count').innerText = count;
}

// ---- Render table dynamically ----
function renderTable(data) {
  const tbody = document.getElementById('todayBody');
  tbody.innerHTML = '';

  data.forEach(p => {
    const id = p['Patient ID'];
    let actionBtn = `<button class="btn btn-sm btn-success" onclick="markYes('${id}')">✅ Yes</button>`;

    if (pendingPatients.has(id)) {
      actionBtn = `
        <button class="btn btn-sm btn-primary" onclick="confirmAttend('${id}')">✔ Confirm</button>
        <button class="btn btn-sm btn-warning" onclick="cancelPending('${id}')">↩ Undo</button>`;
    } else if (attendedPatients.has(id)) {
      actionBtn = `<span class="text-success fw-bold">✔ Attended</span>`;
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${id}</td>
      <td>${p['Name'] || ''}</td>
      <td>${p['Visit Days'] || ''}</td>
      <td>${actionBtn}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ---- Step 1: click Yes ----
function markYes(id) {
  pendingPatients.add(id);
  loadToday();
}

// ---- Step 2: confirm attendance ----
async function confirmAttend(id) {
  try {
    const res = await fetch(`/api/patients/${id}/attend`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'confirm' })
    });
    const result = await res.json();
    if (result.status === 'updated') {
      pendingPatients.delete(id);
      attendedPatients.add(id);
      saveAttendedToStorage(); // ✅ store locally
      loadToday();
    } else {
      alert('Error updating visit count.');
    }
  } catch (err) {
    console.error('Error confirming attendance:', err);
  }
}

// ---- Undo before confirm ----
function cancelPending(id) {
  pendingPatients.delete(id);
  loadToday();
}

loadToday();
</script>

{% endblock %}
